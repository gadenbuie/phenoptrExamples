<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aggregating data from multiple fields â€¢ phenoptrExamples</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Aggregating data from multiple fields">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phenoptrExamples</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/aggregation.html">Aggregating data from multiple fields</a>
    </li>
    <li>
      <a href="../articles/count_touches.html">Aggregating touch counts</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/PerkinElmer/phenoptrExamples">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Aggregating data from multiple fields</h1>
                        <h4 class="author">Kent Johnson</h4>
            
            <h4 class="date">2018-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/PerkinElmer/phenoptrExamples/blob/master/vignettes/aggregation.Rmd"><code>vignettes/aggregation.Rmd</code></a></small>
      <div class="hidden name"><code>aggregation.Rmd</code></div>

    </div>

    
    
<style type="text/css">
img { 
  border: none;
}
table {
    width: auto !important;
}
</style>
<p>This vignette uses the <code>phenoptrExamples</code> sample data and functions from the <a href="http://tidyverse.org/">tidyverse</a> to demonstrate reading and processing cell seg data from multiple fields and samples.</p>
<hr>
<div id="read-multiple-data-files" class="section level2">
<h2 class="hasAnchor">
<a href="#read-multiple-data-files" class="anchor"></a>Read multiple data files</h2>
<p>Use <code>list_cell_seg_files</code> and <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">purrr::map_df</a></code> to read all cell seg data files in a single directory into a single <code>data_frame</code>. The result is similar to reading an inForm merge table.</p>
<div id="find-all-cell-seg-data-files-in-a-directory" class="section level3">
<h3 class="hasAnchor">
<a href="#find-all-cell-seg-data-files-in-a-directory" class="anchor"></a>Find all cell seg data files in a directory</h3>
<p><code>list_cell_seg_files</code> takes a directory path as an argument and returns a list of paths to all the <code>cell_seg_data.txt</code> files in a directory.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(phenoptr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">base_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"samples"</span>, <span class="dt">package =</span> <span class="st">"phenoptrExamples"</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">paths &lt;-<span class="st"> </span><span class="kw"><a href="http://perkinelmer.github.io/phenoptr/reference/list_cell_seg_files.html">list_cell_seg_files</a></span>(base_path)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">length</span>(paths)</a></code></pre></div>
<pre><code>## [1] 9</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">paths[<span class="dv">1</span>]</a></code></pre></div>
<pre><code>## [1] "/Library/Frameworks/R.framework/Versions/3.5/Resources/library/phenoptrExamples/extdata/samples/Set12_20-6plex_[14146,53503]_cell_seg_data.txt"</code></pre>
</div>
<div id="read-and-combine-files" class="section level3">
<h3 class="hasAnchor">
<a href="#read-and-combine-files" class="anchor"></a>Read and combine files</h3>
<p><code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">purrr::map_df</a></code> applies <code>read_cell_seg_data</code> to each path in <code>paths</code>. The <code>data_frame</code>s returned from each call to <code>read_cell_seg_data</code> are combined row-wise to create a single merged <code>data_frame</code>. The result is similar to an inForm merge data file.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">csd &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(paths, read_cell_seg_data)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">dim</span>(csd)</a></code></pre></div>
<pre><code>## [1] 54525   199</code></pre>
<p>Using <code>table</code> is one way to summarize the data by <code>Sample Name</code> or <code>Slide ID</code>. This data comes from nine fields taken of three slides.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">table</span>(csd<span class="op">$</span><span class="st">`</span><span class="dt">Sample Name</span><span class="st">`</span>, csd<span class="op">$</span>Phenotype) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addmargins</span>(<span class="dv">2</span>, <span class="kw">list</span>(<span class="dt">Total=</span>sum))</a></code></pre></div>
<pre><code>##                                   
##                                    CD68+ CD8+  CK+ FoxP3+ other Total
##   Set12_20-6plex_[14146,53503].im3   557  101 2323    305  2659  5945
##   Set12_20-6plex_[15491,58698].im3    87  123 2367    105  2583  5265
##   Set12_20-6plex_[17241,54367].im3   344   79 3799    174  1709  6105
##   Set4_1-6plex_[11472,51360].im3     599  497 1731    512  4521  7860
##   Set4_1-6plex_[15206,60541].im3     112  349 1434    175  3109  5179
##   Set4_1-6plex_[16142,55840].im3     417  228 2257    228  2942  6072
##   Set8_11-6plex_[13394,50883].im3    590   58 2491    266  2088  5493
##   Set8_11-6plex_[14996,59221].im3    199  197 1100    166  3461  5123
##   Set8_11-6plex_[17130,56449].im3    469  259 1861    611  4283  7483</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">table</span>(csd<span class="op">$</span><span class="st">`</span><span class="dt">Slide ID</span><span class="st">`</span>, csd<span class="op">$</span>Phenotype) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addmargins</span>(<span class="dv">2</span>, <span class="kw">list</span>(<span class="dt">Total=</span>sum))</a></code></pre></div>
<pre><code>##                 
##                  CD68+  CD8+   CK+ FoxP3+ other Total
##   Set12_20-6plex   988   303  8489    584  6951 17315
##   Set4_1-6plex    1128  1074  5422    915 10572 19111
##   Set8_11-6plex   1258   514  5452   1043  9832 18099</code></pre>
<hr>
</div>
</div>
<div id="compute-on-merged-data" class="section level2">
<h2 class="hasAnchor">
<a href="#compute-on-merged-data" class="anchor"></a>Compute on merged data</h2>
<p>Merged data may come from an inForm merge or from combining individual files as shown above. In either case, the data includes entries which come from multiple fields. Computing on merged data requires a few new techniques.</p>
<div id="summarize-per-slide" class="section level3">
<h3 class="hasAnchor">
<a href="#summarize-per-slide" class="anchor"></a>Summarize per slide</h3>
<p>Use <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> and <code><a href="http://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarize</a></code> to compute summary statistics for all fields in a slide. For finer grouping, use multiple arguments to <code>group_by</code>. Use <code><a href="http://dplyr.tidyverse.org/reference/filter.html">dplyr::filter</a></code> to select a particular phenotype tissue category.</p>
<p>This example computes the mean PDL1 expression for <code>CD68+</code> and <code>CK+</code> cells in <code>Tumor</code>, with the mean computed per <code>Slide ID</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">csd <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="st">`</span><span class="dt">Tissue Category</span><span class="st">`</span><span class="op">==</span><span class="st">'Tumor'</span>, Phenotype <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">'CD68+'</span>, <span class="st">'CK+'</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Slide ID</span><span class="st">`</span>, Phenotype) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Mean_PDL1=</span><span class="kw">mean</span>(<span class="st">`</span><span class="dt">Entire Cell PDL1 (Opal 520) Mean</span><span class="st">`</span>))</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
## # Groups:   Slide ID [?]
##   `Slide ID`     Phenotype Mean_PDL1
##   &lt;chr&gt;          &lt;chr&gt;         &lt;dbl&gt;
## 1 Set12_20-6plex CD68+         4.59 
## 2 Set12_20-6plex CK+           0.821
## 3 Set4_1-6plex   CD68+         5.32 
## 4 Set4_1-6plex   CK+           3.03 
## 5 Set8_11-6plex  CD68+         4.01 
## 6 Set8_11-6plex  CK+           1.12</code></pre>
</div>
<div id="add-distance-columns-to-merged-data" class="section level3">
<h3 class="hasAnchor">
<a href="#add-distance-columns-to-merged-data" class="anchor"></a>Add distance columns to merged data</h3>
<p>Nearest-neighbor distances must be computed per-sample because the X/Y coordinates reported in cell seg data files are all relative to the top-left of the sample.</p>
<p>Use <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> to aggregate across subsets of a full data set. In this case, we want to group by <code>Sample Name</code>. Within each group, use <code><a href="http://dplyr.tidyverse.org/reference/do.html">dplyr::do</a></code> to call <code>find_nearest_distance</code> to compute the distance columns and <code><a href="http://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_cols</a></code> to combine them with the original data.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Use the same list of phenotypes for each sample</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">phenos &lt;-<span class="st"> </span><span class="kw">unique</span>(csd<span class="op">$</span>Phenotype)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">csd &lt;-<span class="st"> </span>csd <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Sample Name</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="st">  </span><span class="kw">do</span>(<span class="kw">bind_cols</span>(., <span class="kw"><a href="http://perkinelmer.github.io/phenoptr/reference/find_nearest_distance.html">find_nearest_distance</a></span>(., phenos)))</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="kw">dim</span>(csd)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="kw">tail</span>(<span class="kw">names</span>(csd), <span class="dv">5</span>)</a></code></pre></div>
<pre><code>## [1] 54525   205</code></pre>
<pre><code>## [1] "Distance to other"  "Distance to CD68+"  "Distance to FoxP3+"
## [4] "Distance to CK+"    "Distance to CD8+"</code></pre>
</div>
<div id="average-distance-per-sample" class="section level3">
<h3 class="hasAnchor">
<a href="#average-distance-per-sample" class="anchor"></a>Average distance per sample</h3>
<p>The next example uses <code>group_by</code>, <code>filter</code> and <code>summarize</code> again to compute the average distance from a tumor cell (<code>CK+</code>) to the nearest macrophage (<code>CD68+</code>), with the averages computed per <code>Slide ID</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">csd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Slide ID</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(Phenotype<span class="op">==</span><span class="st">'CK+'</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Only tumor cells</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">mean_dist_to_CD68=</span><span class="kw">round</span>(<span class="kw">mean</span>(<span class="st">`</span><span class="dt">Distance to CD68+</span><span class="st">`</span>), <span class="dv">2</span>))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   `Slide ID`     mean_dist_to_CD68
##   &lt;chr&gt;                      &lt;dbl&gt;
## 1 Set12_20-6plex              56.2
## 2 Set4_1-6plex                41.8
## 3 Set8_11-6plex               41.0</code></pre>
</div>
<div id="compute-count_within-for-each-field-in-merged-data" class="section level3">
<h3 class="hasAnchor">
<a href="#compute-count_within-for-each-field-in-merged-data" class="anchor"></a>Compute <code>count_within</code> for each field in merged data</h3>
<p><code>count_within</code> is another function that must be computed per field.</p>
<p>This example uses <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> and <code><a href="http://dplyr.tidyverse.org/reference/do.html">dplyr::do</a></code> to call <code>count_within</code> for each field in a merged data file. The result is a <code>data_frame</code> with one row per radius per field.</p>
<p>Including <code>Slide ID</code> in the <code>group_by</code> arguments doesnâ€™t change the grouping, it causes <code>Slide ID</code> to be included in the result. This is helpful for further aggregation.</p>
<p>See the section <a href="#aggregate-counts-and-means-per-slide">Aggregate counts and means per slide</a> below for an example which aggregates counts per slide.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">csd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Slide ID</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Sample Name</span><span class="st">`</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="st">  </span><span class="kw">do</span>(<span class="kw"><a href="http://perkinelmer.github.io/phenoptr/reference/count_within.html">count_within</a></span>(., <span class="dt">from=</span><span class="st">'CK+'</span>, <span class="dt">to=</span><span class="st">'CD68+'</span>, <span class="dt">radius=</span><span class="dv">15</span>))</a></code></pre></div>
<pre><code>## # A tibble: 9 x 7
## # Groups:   Slide ID, Sample Name [9]
##   `Slide ID`     `Sample Name`                    radius from_count
##   &lt;chr&gt;          &lt;chr&gt;                             &lt;dbl&gt;      &lt;int&gt;
## 1 Set12_20-6plex Set12_20-6plex_[14146,53503].im3     15       2323
## 2 Set12_20-6plex Set12_20-6plex_[15491,58698].im3     15       2367
## 3 Set12_20-6plex Set12_20-6plex_[17241,54367].im3     15       3799
## 4 Set4_1-6plex   Set4_1-6plex_[11472,51360].im3       15       1731
## 5 Set4_1-6plex   Set4_1-6plex_[15206,60541].im3       15       1434
## 6 Set4_1-6plex   Set4_1-6plex_[16142,55840].im3       15       2257
## 7 Set8_11-6plex  Set8_11-6plex_[13394,50883].im3      15       2491
## 8 Set8_11-6plex  Set8_11-6plex_[14996,59221].im3      15       1100
## 9 Set8_11-6plex  Set8_11-6plex_[17130,56449].im3      15       1861
##   to_count from_with within_mean
##      &lt;int&gt;     &lt;int&gt;       &lt;dbl&gt;
## 1      557       273      0.169 
## 2       87       104      0.0503
## 3      344       166      0.0598
## 4      599       387      0.308 
## 5      112        67      0.0530
## 6      417       253      0.158 
## 7      590       261      0.161 
## 8      199        90      0.0918
## 9      469       181      0.134</code></pre>
<hr>
</div>
</div>
<div id="aggregate-count_within-across-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregate-count_within-across-samples" class="anchor"></a>Aggregate <code>count_within</code> across samples</h2>
<div id="compute-counts-and-averages" class="section level3">
<h3 class="hasAnchor">
<a href="#compute-counts-and-averages" class="anchor"></a>Compute counts and averages</h3>
<p>Use <code>count_within_batch</code> to count cells within a radius for multiple tissue categories, phenotypes and fields when the fields have not been merged.</p>
<p>This example counts <code>CK+</code> cells having a <code>CD8+</code> cell within 10 or 25 microns, and <code>CK+</code> cells with a <code>CD68+</code> cell within 10 or 25 microns. <code><a href="http://dplyr.tidyverse.org/reference/reexports.html">dplyr::glimpse</a></code> gives a compact summary of the data.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">base_path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"samples"</span>, <span class="dt">package =</span> <span class="st">"phenoptrExamples"</span>)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">pairs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">'CK+'</span>, <span class="st">'CD8+'</span>),</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">             <span class="kw">c</span>(<span class="st">'CK+'</span>, <span class="st">'CD68+'</span>))</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">radius &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">counts &lt;-<span class="st"> </span><span class="kw"><a href="http://perkinelmer.github.io/phenoptr/reference/count_within_batch.html">count_within_batch</a></span>(base_path, pairs, radius, <span class="dt">verbose=</span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>source, <span class="op">-</span>category) <span class="co"># Remove unneeded columns</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="kw">glimpse</span>(counts)</a></code></pre></div>
<pre><code>## Observations: 36
## Variables: 8
## $ slide_id    &lt;chr&gt; "Set12_20-6plex", "Set12_20-6plex", "Set12_20-6ple...
## $ from        &lt;chr&gt; "CK+", "CK+", "CK+", "CK+", "CK+", "CK+", "CK+", "...
## $ to          &lt;chr&gt; "CD8+", "CD8+", "CD68+", "CD68+", "CD8+", "CD8+", ...
## $ radius      &lt;int&gt; 10, 25, 10, 25, 10, 25, 10, 25, 10, 25, 10, 25, 10...
## $ from_count  &lt;int&gt; 2323, 2323, 2323, 2323, 2367, 2367, 2367, 2367, 37...
## $ to_count    &lt;int&gt; 101, 101, 557, 557, 123, 123, 87, 87, 79, 79, 344,...
## $ from_with   &lt;int&gt; 33, 250, 99, 647, 71, 528, 47, 301, 36, 284, 54, 5...
## $ within_mean &lt;dbl&gt; 0.015927680, 0.136461472, 0.049504950, 0.613861386...</code></pre>
</div>
<div id="aggregate-counts-and-means-per-slide" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregate-counts-and-means-per-slide" class="anchor"></a>Aggregate counts and means per slide</h3>
<p>Aggregating <code>from_count</code>, <code>to_count</code> and <code>from_with</code> across fields is straightforward, it only requires simple sums. Aggregating <code>within_mean</code> requires computing the underlying count of cells within the radius, summing, and computing a new mean.</p>
<p>(Note: the value of <code>from_count * within_mean</code> is not reported by <code>count_with</code> because it may count cells multiple times.)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">counts_per_sample &lt;-<span class="st"> </span>counts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(slide_id, from, to, radius) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">from_count=</span><span class="kw">sum</span>(from_count),</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">              <span class="dt">to_count=</span><span class="kw">sum</span>(to_count),</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">              <span class="dt">from_with=</span><span class="kw">sum</span>(from_with),</a>
<a class="sourceLine" id="cb22-5" data-line-number="5">              <span class="dt">within=</span><span class="kw">sum</span>(from_count<span class="op">*</span>within_mean),</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">              <span class="dt">within_mean=</span>within<span class="op">/</span>from_count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="st">  </span>ungroup <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>within)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8">counts_per_sample</a></code></pre></div>
<pre><code>## # A tibble: 12 x 8
##    slide_id       from  to    radius from_count to_count from_with
##    &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt;  &lt;int&gt;      &lt;int&gt;    &lt;int&gt;     &lt;int&gt;
##  1 Set12_20-6plex CK+   CD68+     10       8489      988       200
##  2 Set12_20-6plex CK+   CD68+     25       8489      988      1482
##  3 Set12_20-6plex CK+   CD8+      10       8489      303       140
##  4 Set12_20-6plex CK+   CD8+      25       8489      303      1062
##  5 Set4_1-6plex   CK+   CD68+     10       5422     1128       288
##  6 Set4_1-6plex   CK+   CD68+     25       5422     1128      1775
##  7 Set4_1-6plex   CK+   CD8+      10       5422     1074       344
##  8 Set4_1-6plex   CK+   CD8+      25       5422     1074      2003
##  9 Set8_11-6plex  CK+   CD68+     10       5452     1258       170
## 10 Set8_11-6plex  CK+   CD68+     25       5452     1258      1484
## 11 Set8_11-6plex  CK+   CD8+      10       5452      514       123
## 12 Set8_11-6plex  CK+   CD8+      25       5452      514       832
##    within_mean
##          &lt;dbl&gt;
##  1      0.0872
##  2      1.03  
##  3      0.0590
##  4      0.498 
##  5      0.173 
##  6      1.84  
##  7      0.239 
##  8      2.21  
##  9      0.0934
## 10      1.51  
## 11      0.0980
## 12      0.871</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#read-multiple-data-files">Read multiple data files</a></li>
      <li><a href="#compute-on-merged-data">Compute on merged data</a></li>
      <li><a href="#aggregate-count_within-across-samples">Aggregate <code>count_within</code> across samples</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kent Johnson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
